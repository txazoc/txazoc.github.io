---
layout: new
title:  动态代理
---

#### JDK动态代理

接口

```java
public interface UserService {

    public String getUserName(int userId);

}
```

实现类

```java
public class UserServiceImpl implements UserService {

    @Override
    public String getUserName(int userId) {
        return "user-" + userId;
    }

}
```

代理类

```java
public class JdkProxy<T> implements InvocationHandler {

    private T target;

    public JdkProxy(T target) {
        this.target = target;
    }

    public T getProxy() {
        return (T) Proxy.newProxyInstance(target.getClass().getClassLoader(), target.getClass().getInterfaces(), this);
    }

    @Override
    public Object invoke(Object proxy, Method method, Object[] args) throws Throwable {
        return method.invoke(target, args);
    }

}
```

```-Dsun.misc.ProxyGenerator.saveGeneratedFiles=true```

```java
public static void main(String[] args) {
    new JdkProxy<UserService>(new UserServiceImpl()).getProxy().getUserName(1000);
}
```

#### CGLib动态代理

CGLib原理: 代理父类

方法拦截器

```java
public class CGLibProxy implements MethodInterceptor {

    /**
     * @param targetClass 被代理父类
     */
    public <T> T getProxy(Class<T> targetClass) {
        Enhancer enhancer = new Enhancer();
        enhancer.setSuperclass(targetClass);
        enhancer.setCallback(this);
        return (T) enhancer.create();
    }

    /**
     * @param object 代理类对象
     * @param method 被调用方法
     * @param args   方法参数
     * @param proxy  方法代理
     */
    @Override
    public Object intercept(Object object, Method method, Object[] args, MethodProxy proxy) throws Throwable {
        Object result = null;
        // 拦截前
        // 调用父类方法
        result = proxy.invokeSuper(object, args);
        // 拦截后
        return result;
    }

}
```

```java
@Test
public void test() {
    System.setProperty(DebuggingClassWriter.DEBUG_LOCATION_PROPERTY, "/Users/txazo/test");
    UserService proxy = new CGLibProxy().getProxy(UserServiceImpl.class);
    proxy.getUserName(1000);
}
```

反编译后的代理类

```java
public class UserServiceImpl$$EnhancerByCGLIB$$980faa7b
        extends UserServiceImpl implements Factory {

    // 方法拦截器
    private MethodInterceptor CGLIB$CALLBACK_0;
    // CGLIB$getUserName$0方法
    private static final Method CGLIB$getUserName$0$Method;
    // CGLIB$getUserName$0方法代理
    private static final MethodProxy CGLIB$getUserName$0$Proxy;

    final String CGLIB$getUserName$0(int paramInt) {
        // 调用父类方法
        return super.getUserName(paramInt);
    }

    public final String getUserName(int paramInt) {
        MethodInterceptor interceptor = this.CGLIB$CALLBACK_0;
        if (interceptor != null) {
            // 执行方法拦截
            return (String) interceptor.intercept(this, CGLIB$getUserName$0$Method,
                    new Object[]{new Integer(paramInt)}, CGLIB$getUserName$0$Proxy);
        }
        // 无方法拦截器, 直接调用父类方法
        return super.getUserName(paramInt);
    }

}
```
