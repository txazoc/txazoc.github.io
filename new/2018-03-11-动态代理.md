---
layout: new
title:  动态代理
---

#### JDK动态代理

接口:

```java
public interface UserService {

    public String getUserName(int userId);

}
```

实现类:

```java
public class UserServiceImpl implements UserService {

    @Override
    public String getUserName(int userId) {
        return "user_" + userId;
    }

}
```

InvocationHandler实现类:

```java
public class JdkProxy<T> implements InvocationHandler {

    private T target;

    public JdkProxy(T target) {
        this.target = target;
    }

    public T getProxy() {
        return (T) Proxy.newProxyInstance(target.getClass().getClassLoader(), target.getClass().getInterfaces(), this);
    }

    @Override
    public Object invoke(Object proxy, Method method, Object[] args) throws Throwable {
        Object result = null;
        // 拦截前
        // 调用被代理类的方法
        result method.invoke(target, args);
        // 拦截后
        return result;
    }

}
```

保存生成的代理类到文件: ```-Dsun.misc.ProxyGenerator.saveGeneratedFiles=true```

JDK动态代理测试:

```java
public static void main(String[] args) {
    new JdkProxy<UserService>(new UserServiceImpl()).getProxy().getUserName(1000);
}
```

反编译后的代理类:

```java
public final class $Proxy0 extends Proxy implements UserService {

    private static Method m1;
    private static Method m2;
    private static Method m3;
    private static Method m0;

    static {
        try {
            m1 = Class.forName("java.lang.Object").getMethod("equals", new Class[]{Class.forName("java.lang.Object")});
            m2 = Class.forName("java.lang.Object").getMethod("toString", new Class[0]);
            m3 = Class.forName("org.txazo.java.aop.UserService").getMethod("getUserName", new Class[]{Integer.TYPE});
            m0 = Class.forName("java.lang.Object").getMethod("hashCode", new Class[0]);
        } catch (NoSuchMethodException localNoSuchMethodException) {
            throw new NoSuchMethodError(localNoSuchMethodException.getMessage());
        } catch (ClassNotFoundException localClassNotFoundException) {
            throw new NoClassDefFoundError(localClassNotFoundException.getMessage());
        }
    }

    public $Proxy0(InvocationHandler h) {
        super(h);
    }

    public final boolean equals(Object paramObject) {
        try {
            return ((Boolean) this.h.invoke(this, m1, new Object[]{paramObject})).booleanValue();
        } catch (Error | RuntimeException localError) {
            throw localError;
        } catch (Throwable localThrowable) {
            throw new UndeclaredThrowableException(localThrowable);
        }
    }

    public final String toString() {
        try {
            return (String) this.h.invoke(this, m2, null);
        } catch (Error | RuntimeException localError) {
            throw localError;
        } catch (Throwable localThrowable) {
            throw new UndeclaredThrowableException(localThrowable);
        }
    }

    public final String getUserName(int paramInt) {
        try {
            return (String) this.h.invoke(this, m3, new Object[]{Integer.valueOf(paramInt)});
        } catch (Error | RuntimeException localError) {
            throw localError;
        } catch (Throwable localThrowable) {
            throw new UndeclaredThrowableException(localThrowable);
        }
    }

    public final int hashCode() {
        try {
            return ((Integer) this.h.invoke(this, m0, null)).intValue();
        } catch (Error | RuntimeException localError) {
            throw localError;
        } catch (Throwable localThrowable) {
            throw new UndeclaredThrowableException(localThrowable);
        }
    }

}
```

#### CGLib动态代理

MethodInterceptor实现类:

```java
public class CGLibProxy implements MethodInterceptor {

    /**
     * @param targetClass 被代理类
     */
    public <T> T getProxy(Class<T> targetClass) {
        Enhancer enhancer = new Enhancer();
        enhancer.setSuperclass(targetClass);
        enhancer.setCallback(this);
        return (T) enhancer.create();
    }

    /**
     * @param object 代理类对象
     * @param method 被调用方法
     * @param args   方法参数
     * @param proxy  方法代理
     */
    @Override
    public Object intercept(Object object, Method method, Object[] args, MethodProxy proxy) throws Throwable {
        Object result = null;
        // 拦截前
        // 调用父类方法
        result = proxy.invokeSuper(object, args);
        // 拦截后
        return result;
    }

}
```

CGLib动态代理测试:

```java
public static void main(String[] args) {
    System.setProperty(DebuggingClassWriter.DEBUG_LOCATION_PROPERTY, "/Users/txazo/test");
    new CGLibProxy().getProxy(UserServiceImpl.class).getUserName(1000);
}
```

反编译后的代理类:

```java
public class UserServiceImpl$$EnhancerByCGLIB$$980faa7b
        extends UserServiceImpl implements Factory {

    // 方法拦截器
    private MethodInterceptor CGLIB$CALLBACK_0;
    // CGLIB$getUserName$0方法
    private static final Method CGLIB$getUserName$0$Method;
    // CGLIB$getUserName$0方法代理
    private static final MethodProxy CGLIB$getUserName$0$Proxy;

    final String CGLIB$getUserName$0(int paramInt) {
        // 调用父类方法
        return super.getUserName(paramInt);
    }

    public final String getUserName(int paramInt) {
        MethodInterceptor interceptor = this.CGLIB$CALLBACK_0;
        if (interceptor != null) {
            // 执行方法拦截
            return (String) interceptor.intercept(this, CGLIB$getUserName$0$Method,
                    new Object[]{new Integer(paramInt)}, CGLIB$getUserName$0$Proxy);
        }
        // 无方法拦截器, 直接调用父类方法
        return super.getUserName(paramInt);
    }

}
```
