---
layout: new
title:  事务
---

#### 什么是事务

#### ACID

ACID是事务的四个特性

* A: 原子性，Atomicity
* C: 一致性，Consistency
* I: 隔离性，Isolation
* D: 持久性，Durability

单机单事务，原子性、一致性和持久性都可保证

单机并发事务，原子性和持久性都可保证，一致性和隔离性

#### 事务隔离级别

事务并发会带来不一致的问题:

* 脏读
* 不可重复读
* 幻读

为此，定义四种事务隔离级别

* Read_Uncommitted: 读未提交
* Read_Committed: 读已提交
* Repeatable_Read: 可重复读
* Serializable: 串行化

#### Spring声明式事务管理

基于注解的声明式事务管理

```xml
<beans>

    <!-- 事务管理器 -->
    <bean id="transactionManager" class="org.springframework.jdbc.datasource.DataSourceTransactionManager">
        <property name="dataSource" ref="dataSource" />
    </bean>

    <!-- 开启注解事务 -->
    <tx:annotation-driven transaction-manager="transactionManager" />

</beans>
```

在要用到事务的地方使用`@Transactional`注解

```java
@Transactional
public void update() {
}
```

#### Spring事务传播机制

#### InnoDB事务实现

***InnoDB的日志***:

* redo log: 重做日志，顺序记录数据变更的操作
* undo log: 撤销日志，记录数据变更的反向操作

```console
mysql> select * from Account;
+----+--------+--------+
| id | userId | amount |
+----+--------+--------+
|  1 |   1000 |  100   |
|  2 |   2000 |  200   |
+----+--------+--------+
```

```sql
start transaction;
update Account set amount += 50 where userId = 1000;
update Account set amount -= 50 where userId = 2000;
commit;
```

```console
1. 开始事务

2. 记录undo log: update Account set amount -= 50 where userId = 1000
3. 修改buffer pool: update Account set amount += 50 where userId = 1000
4. 记录redo log: update Account set amount += 50 where userId = 1000

5. 记录undo log: update Account set amount += 50 where userId = 2000
6. 修改buffer pool: update Account set amount -= 50 where userId = 2000
7. 记录redo log: update Account set amount -= 50 where userId = 2000

8. redo log写入磁盘
9. 提交事务
```

***InnoDB中ACID的实现***:

* 原子性的实现
    * undo log
* 一致性的实现
    * MVCC
* 隔离性的实现
    * 锁
    * MVCC
* 持久性的实现
    * redo log
