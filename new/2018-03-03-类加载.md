---
layout: new
title:  类加载
---

#### 类加载器

* 启动类加载器
    * 查找目录: sun.boot.class.path
* 扩展类加载器: `Launcher.ExtClassLoader`
    * 查找目录: java.ext.dirs
* 应用程序类加载器: `Launcher.AppClassLoader`
    * 查找目录: java.class.path
* 自定义类加载器

#### 类加载

* JVM启动创建启动类加载器
* 启动类加载器加载`sun.launcher.LauncherHelper`
    * LauncherHelper初始化
        * 创建扩展类加载器
        * 创建系统类加载器 = 应用程序类加载器

```java
static jclass LoadMainClass(JNIEnv *env, int mode, char *name) {
    // 启动类加载器加载sun/launcher/LauncherHelper
    jclass cls = GetLauncherHelperClass(env);
    // 获取LauncherHelper的checkAndLoadMain方法
    mid = (*env)->GetStaticMethodID(env, cls, "checkAndLoadMain", "(ZILjava/lang/String;)Ljava/lang/Class;");
    // 调用LauncherHelper的checkAndLoadMain方法加载main类
    result = (*env)->CallStaticObjectMethod(env, cls, mid, USE_STDERR, mode, str);
    return (jclass) result;
}

jclass GetLauncherHelperClass(JNIEnv *env) {
    return FindBootStrapClass(env, "sun/launcher/LauncherHelper");
}
```

```java
public enum LauncherHelper {

    INSTANCE;

    // 初始化系统类加载器
    private static final ClassLoader scloader = ClassLoader.getSystemClassLoader();

}
```

* LauncherHelper.checkAndLoadMain()
    * 系统类加载器加载`main`类，并检查`main()`方法
    * 调用`main`类的`main()`方法

#### Loading-装载

* ClassLoader.loadClass(): 双亲委派机制
    * findLoadedClass(): 当前类加载器查找已加载的类
    * parent.loadClass(): 未找到，委托给父加载器加载
    * findClass(): 父加载器也未找到，当前类加载器查找并加载
        * 通过`className`找到`.class`对应的`二进制字节码`
        * defineClass(): 解析`二进制字节码`生成Class对象

#### Linking-链接

* 校验
* 准备: 类静态变量分配内存空间，并初始化为默认值
* 解析: 类中的符号引用转换为直接引用

#### Initializing-初始化

* 父类未初始化，先初始化父类
* 依次给类静态变量赋初始值和执行静态代码块
