---
layout: new
title:  分布式事务
---

#### XA两阶段提交

两阶段提交，2PC

* Prepare Phase: 准备阶段
    * prepare
* Commit Phase: 提交阶段
    * commit()或rollback()
    * 释放锁资源

#### TCC

TCC，Try-Confirm-Cancel

* Try: 业务检查，预留资源
* Confirm: 执行业务，不做业务检查
* Cancel: 业务回滚，释放预留资源

<img src="/images/tx/tcc.jpg" style="width: 480px; border-width: 0px;" />

```java
public void tccTransaction() {
    // 主业务服务: try
    resultB = tryB();
    resultC = tryC();

    // 业务活动管理器: confirm
    if (resultB && resultC) {
        resultB = confirmB();
        resultC = confirmC();
    }

    // 业务活动管理器: cancel
    if (!resultB || !resultC) {
        cancelB();
        cancelC();
    }
}
```

#### 非事务消息

```java
public void transaction() {
    // 执行本地事务
    boolean result = dao.update();
    if (result) {
        // 发送消息
        result = mq.send(message);
    }
    if (!result) {
        // 失败回滚
        rollback();
    }
}
```

消息消费端面临的问题:

* 保证消息的持久化
* 消息消费失败重试
* 避免消息重复消费

#### 本地消息表

* 远程分布式事务转换为本地事务

```sql
start transaction;
    update Account set amount = amount - 100 where userId = 10000
    insert into AccountMessage(userId, amount, status) values(10001, 100, 1);
commit
```

* 通知
    * MQ
    * 定时轮询

#### 事务补偿机制
