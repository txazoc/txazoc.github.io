---
layout: topic
module: 项目总结
title:  移动运营平台
date:   2017-02-12
---

#### 背景

***导航***

<img src="/images/topic/project/operatingplatform/icon.png" style="width: 320px" title="导航" />

***模块***

<img src="/images/topic/project/operatingplatform/module.png" style="width: 320px" title="模块" />

***列表***

<img src="/images/topic/project/operatingplatform/list.png" style="width: 320px" title="列表" />

App上类似上面的功能需求比较多，传统的做法是写死在后端代码中，每次修改都重新发布。好一点的做法是放在配置中心上进行配置，但没办法解决不同版本、城市、时间等问题。

#### 过滤筛选

* 城市: 城市筛选
* 平台: Android、IOS
* 版本: 最小版本号 -> 最大版本号
* 渠道: Android包的投放渠道
* 时间: 开始时间 -> 结束时间

#### 数据库设计

* 场景: 对应一个模块的配置
* 配置: 配置的基本信息
* 内容: 配置的过滤信息和具体内容
* 包: 包含一个场景下配置的全部内容

它们之间的关系: 

* 场景 -> 配置: 一对多
* 配置 -> 内容: 一对多

为防止后台配置的数据和线上发布的数据冲突，引入打包机制将后台数据和线上数据隔离开:

* 后台表: 存放后台实时配置的数据
* 线上表: 存放打包后的数据
* `打包`: 后台表数据同步到线上表
* `回滚`: 线上表数据同步到后台表

#### 字段动态化多样化

***动态化***

支持动态添加、修改、删除字段，数据库中采用json格式存储

***多样化***

* 类型多样化: bool、int、double、string、json
* 控件多样化: 文本、富文本、URL、图片、下拉框、复选框、时间控件、颜色控件、城市控件

#### 其它模块

* 权限管理
* 锁机制: 防止并发修改冲突
* 审核上线

#### 完整的审核上线流程

`配置` -> `打包` -> `测试` -> `审核` -> `上线` -> `回滚`

#### 接入方式

* sdk接入
* rpc接入

#### 多级缓存架构

* sdk缓存: 封装为jar包
* 服务缓存: 提供rpc服务
* 二级缓存: 本地缓存(ConcurrentHashMap) + 分布式缓存(Redis)

服务缓存流程:

* `填充或更新缓存`: 从数据库查询数据，填充或更新到本地缓存和分布式缓存
* `缓存预填充`: 应用启动，异步`填充缓存`
* 数据查询: 先`查询本地缓存`，不存在则`查询分布式缓存`
* `定时更新缓存`: `更新缓存`，更新频率60s
* `数据变更监听`: 数据变更，触发Zookeeper监听事件，`更新缓存`

sdk缓存流程:

* 同服务缓存，不同点如下
* 数据查询: 先`查询本地缓存`，不存在则调用`rpc服务查询数据`

#### 解决的问题?

* 分布式缓存抖动问题: 使用本地缓存分担分布式缓存压力
* 缓存实效导致高并发查询数据库问题: `缓存预填充` + `定时更新缓存` + `二级缓存`，避免缓存失效主动查询数据库
* 缓存一致性问题: `定时更新缓存` + `数据变更监听`，保证缓存的最终一致性
* QPS过高影响应用负载问题: `sdk缓存`，数据直接缓存在调用方本地
