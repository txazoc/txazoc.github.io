---
layout:     article
categories: [cache]
title:      缓存
tags:       [cache, 缓存, 分布式, 分布式缓存]
date:       2016-04-14
---

> `缓存`，存储数据的临时区。

缓存的目的是把数据暂存在距离用户更近或用户能更快获取的地方，以达到更快的数据访问速度。

#### 缓存概念

* `缓存命中`，缓存中存在请求的数据
* `缓存未命中`，缓存中不存在请求的数据，也称为`缓存失效`
* `缓存填充`，缓存未命中时，请求原始数据并放入缓存
* `缓存命中率`，全部请求中`命中缓存`的请求所占的比例

下面来分别介绍下各种缓存，包括：CPU高速缓存、浏览器缓存、CDN缓存、反向代理缓存、应用缓存、分布式缓存、数据库中间件缓存、数据库缓存。

#### CPU缓存

CPU缓存主要是为了解决CPU运算速度和内存读写速度不匹配的矛盾。

CPU缓存可以分为L1缓存、L2缓存，部分CPU还包含L3缓存。CPU读取数据时，先从L1缓存查找，未命中再去L2缓存查找，还是未命中就去L3缓存或内存查找。一般情况下，每级缓存的命中率为80%左右，也就是说80%的数据从L1缓存获取，16%的数据从L2缓存获取，4%的数据从L3缓存或内存获取。

#### 浏览器缓存

浏览器缓存是为了节约网络资源加速浏览。

浏览器缓存存在的问题？服务器的文件更新后，如何通知到浏览器，为了解决这个问题，引入`缓存协商`。

* `Cache-Control`，资源的有效期，常见的值有`no-cache`(不缓存)、`max-age`(最大缓存时间)
* `Last-Modified`和`If-Modified-Since`，资源的最新更新时间，配合`Cache-Control`使用
* `Etag`和`If-None-Match`，资源的唯一标识，配合`Cache-Control`使用。服务器响应时，对资源的内容进行hash得到Etag的值，返回给浏览器。资源过期(Cache-Control的max-age)时，浏览器发现资源有Etag声明，从服务器请求时带上If-None-Match头(值为Etag的值)，服务器接受请求，发现有If-None-Match，和被请求资源的Etag值进行对比，相同返回200，不同返回304。

`Etag`和`Last-Modified`实现的功能类似，主要区别在于`Etag`的关注点为资源的内容，`Last-Modified`的关注点为资源的更新时间。

#### CDN缓存

CDN缓存主要实现是对静态资源的加速访问。

CDN缓存的原理？首先，CDN是由智能DNS服务器和CDN节点服务器组成的分布式网络系统，CDN节点服务器分布在全国或全世界各地。用户请求静态资源时，通过DNS解析将静态资源的原始域名`CNAME`到CDN的智能DNS服务器的域名，由智能DNS服务器接管DNS解析，智能DNS服务器根据用户请求的IP/地理位置，返回距离用户最近的CDN节点服务器的IP地址，然后，用户的浏览器向该CDN节点请求静态资源，CDN节点检查静态资源是否存在，存在直接返回，不存在，就向静态资源的原始服务器请求返回给用户，并将静态资源缓存在该CDN节点上。

CDN缓存带来的问题？静态资源更新后，如何通知到CDN节点进行更新？常见的有两种方案，方案一：CDN提供静态资源的更新接口，当静态资源更新后，调用CDN提供的接口更新即可，方案二，CDN是根据静态资源的URL来进行标识的，当静态资源更新后，更新静态资源的URL，这样，CDN节点就会根据新的URL拉取静态资源，具体做法是在URL的参数里面加上版本号的标识，比如`http://www.txazo.com/index.html?v=20160424180000`，版本号的标识可以是时间戳、md5值或其它唯一标识。

#### 反向代理缓存

反向代理缓存，以代理服务器接受请求

#### 应用缓存

Java中的应用缓存主要有HashMap和EhCache。

#### 分布式缓存

分布式缓存主要有Memcached和Redis。

#### 数据库中间件缓存

Java的数据库中间件MyBatis和Hibernate都提供缓存的功能。

#### 数据库缓存
