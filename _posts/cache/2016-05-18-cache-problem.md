---
layout:     article
categories: [cache]
title:      分布式缓存的问题
tags:       [缓存, 分布式]
date:       2016-05-18
---

分布式缓存面临的问题有缓存穿透、缓存失效、缓存宕机。

#### 缓存穿透

缓存穿透，查询一个一定不存在的数据，缓存未命中，查询数据库，结果为空不写入缓存，导致每次请求都会查询数据库，失去缓存的意义。

缓存穿透的问题有以下几种解决方案：

* 方案一，对空结果进行缓存，过期时间设置短一点，比如几分钟
* 方案二，

#### 缓存失效

缓存失效，查询数据库，填充缓存，给数据库带来压力。

缓存失效主要有两种场景，一种是高并发下的缓存失效，另一种是缓存服务器宕机。

缺点：高并发情况下，会造成多次数据库查询，分布式环境下，数据库查询次数更多，给数据库带来压力。

既然，高并发情况下，有多次数据库查询，可以控制单机下，对同一个key，只有一个线程去查询数据库填充缓存，其它线程等待缓存填充完成。

下面是基于Memcached的实现。

单机控制只有一个线程去查询数据库，但分布式环境下，每台机器都会去查询数据库，机器越多，对数据库带来的压力越大。

针对分布式环境，可以控制只有一台机器去查询数据库并填充缓存，其它机器则等待缓存填充完成。

上面的设计，缓存失效后才进行填充，查询缓存的请求会被wait。

一种更好的思路是进行缓存预填充，在缓存快要失效前，开启额外的线程去查询数据库并填充缓存。
